<div #canvasContainer class="canvas-container" [class.is-panning]="isPanning">
  <div 
    #canvas 
    class="canvas" 
    [class.is-panning]="isPanning"
    [style.width.px]="canvasWidth()"
    [style.height.px]="canvasHeight()"
    [ngStyle]="canvasStyle()"
    (mousedown)="onCanvasMouseDown($event)"
    (click)="onCanvasClick($event)"
  >
    <div class="screen-indicator">
      1920x1080 Â· {{ scalePercent() }}%
    </div>
    <div class="snap-guides">
      @for (position of snapGuides().vertical; track position) {
        <div
          class="snap-guide snap-guide-vertical"
          [style.left.px]="position"
          [style.height.px]="canvasHeight()"
        ></div>
      }

      @for (position of snapGuides().horizontal; track position) {
        <div
          class="snap-guide snap-guide-horizontal"
          [style.top.px]="position"
          [style.width.px]="canvasWidth()"
        ></div>
      }
    </div>

    <ng-template #elementTemplate let-element let-parent="parent">
      <div 
        class="ui-element"
        [class.child-element]="!!parent"
  [class.selected]="selectedElementIdSet().has(element.id)"
        [class.dragging]="isDragging && dragElement?.id === element.id"
        [class.locked]="element.locked"
        [style]="getElementStyle(element, parent)"
        (click)="onElementClick($event, element.id)"
        (mousedown)="onElementMouseDown($event, element.id)"
      >
        <div class="element-content">
          @switch (element.type) {
            @case ('Container') {
              <div class="container-content" [style]="getBackgroundStyle(element)">
                @if (showContainerLabels()) {
                  {{element.name}}
                }
              </div>
            }
            @case ('Text') {
              <div class="text-content" [style]="getTextStyle(element)">
                {{element.textLabel || element.name}}
              </div>
            }
            @case ('Image') {
              <div class="image-content" [style]="getImageStyle(element)">
                <span class="image-placeholder">{{element.imageType}}</span>
              </div>
            }
            @case ('Button') {
              <button class="button-content" [style]="getButtonStyle(element)">
                {{element.textLabel || element.name}}
              </button>
            }
          }
        </div>

        @if (element.locked) {
          <div class="element-lock-indicator" title="Element is locked">ðŸ”’</div>
        }

        <!-- Resize handles for selected elements -->
        @if (element.id === selectedElementId() && !element.locked) {
          <div class="resize-handle resize-handle-right" 
               (mousedown)="onResizeStart($event, element.id, 'right')"></div>
          <div class="resize-handle resize-handle-bottom" 
               (mousedown)="onResizeStart($event, element.id, 'bottom')"></div>
          <div class="resize-handle resize-handle-corner" 
               (mousedown)="onResizeStart($event, element.id, 'corner')"></div>
        }

        <!-- Nested child elements -->
        @for (child of element.children ?? []; track child.id) {
          <ng-container 
            *ngTemplateOutlet="elementTemplate; context: {$implicit: child, parent: element}"
          ></ng-container>
        }
      </div>
    </ng-template>

    @for (element of elements(); track element.id) {
      <ng-container 
        *ngTemplateOutlet="elementTemplate; context: {$implicit: element, parent: null}"
      ></ng-container>
    }
  </div>
</div>