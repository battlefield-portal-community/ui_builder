<div class="side-menu" [class.is-collapsed]="isCollapsed()">
  <div class="menu-header">
    <div class="menu-header__titles">
      <h3>{{ headerTitle() }}</h3>
      @if (!isCollapsed()) {
        <span class="menu-subtitle">Element library</span>
      }
    </div>
    <button
      type="button"
      class="collapse-button"
      (click)="toggleCollapse()"
      [attr.aria-label]="collapseToggleLabel()"
      [title]="collapseToggleLabel()"
      [attr.aria-expanded]="!isCollapsed()"
    >
      {{ isCollapsed() ? '>' : '<' }}
    </button>
  </div>

  @if (!isCollapsed()) {
    <!-- Add Element Section -->
    <div class="menu-section">
    <h4>Add Element</h4>
    <div class="element-types">
      @for (type of elementTypes; track type) {
        <button 
          type="button"
          class="element-type-btn"
          (click)="addElement(type)"
          [disabled]="isAddButtonDisabled(type)"
          [title]="getAddButtonTitle(type)"
          [style.opacity]="isAddButtonDisabled(type) ? 0.2 : 1"
        >
          <span class="element-icon">{{getElementIcon(type)}}</span>
          <span class="element-label">{{type}}</span>
        </button>
      }
    </div>
    @if (hasAdvancedPresets()) {
      <div class="advanced-presets">
        <button
          type="button"
          class="advanced-toggle-btn"
          (click)="toggleAdvancedPresetList()"
        >
          <span class="advanced-toggle-label">Advanced widgets</span>
          <span class="advanced-toggle-count">{{advancedPresets().length}}</span>
          <span class="advanced-toggle-icon">{{showAdvancedPresets() ? '‚ñ≤' : '‚ñº'}}</span>
        </button>
        @if (showAdvancedPresets()) {
          <div class="advanced-presets__list">
            @for (preset of advancedPresets(); track preset.id) {
              <button
                type="button"
                class="advanced-preset-btn"
                (click)="addAdvancedPreset(preset.id)"
                [title]="'Add ' + preset.label"
              >
                <div class="advanced-preset__header">
                  <span class="advanced-preset__label">{{preset.label}}</span>
                  @if (preset.category) {
                    <span class="advanced-preset__category">{{preset.category}}</span>
                  }
                </div>
                @if (preset.description) {
                  <span class="advanced-preset__description">{{preset.description}}</span>
                }
              </button>
            }
          </div>
        }
      </div>
    }
    <div class="add-info">
      @if (selectedElement(); as selected) {
        <span class="add-target">Adding to: <strong>{{selected.name}}</strong></span>
      } @else {
        <span class="add-target">Adding to: <strong>Root</strong></span>
      }
    </div>
    </div>

    <!-- Snapping -->

    <!-- Element Hierarchy -->
    <div class="menu-section">
    <h4>Element Hierarchy</h4>
    <div class="element-tree">
      @if (elements().length === 0) {
        <div class="empty-state">No elements yet</div>
      } @else {
        <div
          class="drop-zone drop-zone--root"
          [class.is-active]="isDropHint(null, 'root-start')"
          (dragover)="onDragOverZone($event, { targetId: null, parentId: null, index: 0, mode: 'root-start' })"
          (dragleave)="onDragLeaveZone($event, { targetId: null, parentId: null, index: 0, mode: 'root-start' })"
          (drop)="onDropZone($event, { targetId: null, parentId: null, index: 0, mode: 'root-start' })"
        ></div>
        @for (item of flattenedElements(); track item.element.id) {
          <div
            class="drop-zone drop-zone--between"
            [class.is-active]="isDropHint(item.element.id, 'before')"
            [style.margin-left.px]="item.level * 20"
            (dragover)="onDragOverZone($event, { targetId: item.element.id, parentId: item.parentId, index: item.index, mode: 'before' })"
            (dragleave)="onDragLeaveZone($event, { targetId: item.element.id, parentId: item.parentId, index: item.index, mode: 'before' })"
            (drop)="onDropZone($event, { targetId: item.element.id, parentId: item.parentId, index: item.index, mode: 'before' })"
          ></div>
          <div class="tree-element" [class.selected]="selectedElementIdSet().has(item.element.id)" [class.locked]="item.element.locked">
            <div 
              class="element-item"
              draggable="true"
              (dragstart)="onDragStart($event, item.element.id)"
              (dragend)="onDragEnd()"
              (click)="selectElement(item.element.id)"
              [style.padding-left.px]="item.level * 20"
            >
              <span class="child-indicator">{{getIndentIndicator(item.level)}}</span>
              <span class="element-icon">{{getElementIcon(item.element.type)}}</span>
              <span class="element-name">
                {{item.element.name}}
                @if (item.element.locked) {
                  <span class="element-lock-label">(Locked)</span>
                }
              </span>
              <div class="element-actions">
                <button
                  class="action-btn lock-btn"
                  draggable="false"
                  (click)="toggleElementLock($event, item.element)"
                  [title]="item.element.locked ? 'Unlock element' : 'Lock element'"
                >
                  {{ item.element.locked ? 'üîì' : 'üîí' }}
                </button>
                <button 
                  class="action-btn delete-btn"
                  draggable="false"
                  (click)="deleteElement($event, item.element.id)"
                  title="Delete element"
                >
                  üóëÔ∏è
                </button>
              </div>
            </div>
            @if (item.element.type === 'Container') {
              <div
                class="drop-zone drop-zone--child"
                [class.is-active]="isDropHint(item.element.id, 'child')"
                [style.margin-left.px]="(item.level + 1) * 20"
                (dragover)="onDragOverZone($event, { targetId: item.element.id, parentId: item.element.id, index: item.element.children?.length ?? 0, mode: 'child' })"
                (dragleave)="onDragLeaveZone($event, { targetId: item.element.id, parentId: item.element.id, index: item.element.children?.length ?? 0, mode: 'child' })"
                (drop)="onDropZone($event, { targetId: item.element.id, parentId: item.element.id, index: item.element.children?.length ?? 0, mode: 'child' })"
              >
                <span class="drop-zone__label">Drop into {{item.element.name}}</span>
              </div>
            }
          </div>
          <div
            class="drop-zone drop-zone--between"
            [class.is-active]="isDropHint(item.element.id, 'after')"
            [style.margin-left.px]="item.level * 20"
            (dragover)="onDragOverZone($event, { targetId: item.element.id, parentId: item.parentId, index: item.index + 1, mode: 'after' })"
            (dragleave)="onDragLeaveZone($event, { targetId: item.element.id, parentId: item.parentId, index: item.index + 1, mode: 'after' })"
            (drop)="onDropZone($event, { targetId: item.element.id, parentId: item.parentId, index: item.index + 1, mode: 'after' })"
          ></div>
        }
        <div
          class="drop-zone drop-zone--root"
          [class.is-active]="isDropHint(null, 'root-end')"
          (dragover)="onDragOverZone($event, { targetId: null, parentId: null, index: elements().length, mode: 'root-end' })"
          (dragleave)="onDragLeaveZone($event, { targetId: null, parentId: null, index: elements().length, mode: 'root-end' })"
          (drop)="onDropZone($event, { targetId: null, parentId: null, index: elements().length, mode: 'root-end' })"
        ></div>
      }
    </div>
    </div>

    <!-- Actions -->
    <div class="menu-section">
    <h4>Actions</h4>
    <div class="actions">
      <button 
        class="action-button duplicate-btn"
        (click)="duplicateSelectedElement()"
        [disabled]="!selectedElementId()"
      >
        üìã Duplicate selected element
      </button>
      <button 
        class="action-button clear-btn"
        (click)="clearAll()"
        [disabled]="elements().length === 0"
      >
        üóëÔ∏è Clear All
      </button>
    </div>
    </div>
  }
</div>