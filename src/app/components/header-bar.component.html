<header class="header-bar">
  <div class="header-main">
    <div class="brand">
      <span class="brand__title">UI Builder V1.1.0</span>
      <span class="brand__subtitle">Battlefield Portal</span>
    </div>

    <div class="background-controls">
      <div class="background-mode">
        <span class="background-mode__label">Canvas background:</span>
        <label class="mode-option">
          <input
            type="radio"
            name="canvas-background-mode"
            [checked]="backgroundMode() === 'black'"
            (change)="setBackgroundMode('black')"
          />
          <span class="mode-pill mode-pill--black">Black</span>
        </label>
        <label class="mode-option">
          <input
            type="radio"
            name="canvas-background-mode"
            [checked]="backgroundMode() === 'white'"
            (change)="setBackgroundMode('white')"
          />
          <span class="mode-pill mode-pill--white">White</span>
        </label>
        <label class="mode-option">
          <input
            type="radio"
            name="canvas-background-mode"
            [checked]="backgroundMode() === 'image'"
            (change)="setBackgroundMode('image')"
          />
          <span class="mode-pill mode-pill--image">Image</span>
        </label>

        @if (backgroundMode() === 'image') {
          <div class="background-image-controls">
            <label class="background-upload">
              <input
                class="background-upload__input"
                type="file"
                accept="image/*"
                multiple
                (change)="onBackgroundImageUpload($event)"
              />
              <span class="background-upload__icon">‚¨ÜÔ∏è</span>
              <span class="background-upload__text">Upload</span>
            </label>

            <div class="background-carousel">
              <button
                type="button"
                class="background-tile"
                [class.selected]="isBackgroundImageSelected(defaultBackgroundImage.id)"
                (click)="setBackgroundImage(defaultBackgroundImage.id)"
                [title]="defaultBackgroundImage.fileName"
              >
                <span class="background-tile__badge">Default</span>
                <span
                  class="background-tile__preview"
                  [style.background-image]="'url(' + defaultBackgroundImage.url + ')'"
                ></span>
                <span class="background-tile__label">{{ defaultBackgroundImage.label }}</span>
              </button>

              @for (image of backgroundImages(); track image.id) {
                <button
                  type="button"
                  class="background-tile"
                  [class.selected]="isBackgroundImageSelected(image.id)"
                  (click)="setBackgroundImage(image.id)"
                  [title]="image.fileName"
                >
                  <span
                    class="background-tile__preview"
                    [style.background-image]="'url(' + image.url + ')'"
                  ></span>
                  <span class="background-tile__label">{{ image.label }}</span>
                </button>
              }
            </div>

            @if (backgroundImages().length === 0) {
              <div class="background-empty">
                Uploaded images will appear here.
              </div>
            }
          </div>
        } @else {
          <div class="background-solid">
            <span
              class="solid-swatch"
              [class.solid-swatch--black]="backgroundMode() === 'black'"
              [class.solid-swatch--white]="backgroundMode() === 'white'"
            ></span>
            <span class="solid-label">{{ backgroundMode() | titlecase }} background active</span>
          </div>
        }
      </div>
    </div>

    <div class="header-actions">
      <button
        type="button"
        class="action-button"
        (click)="openImportModal()"
        title="Import UI TypeScript snippet"
      >
        üì• Import UI
      </button>
      <button
        type="button"
        class="action-button"
        (click)="exportArtifactsToJson()"
        [disabled]="elements().length === 0"
        title="Export UI artifacts"
      >
        üìÑ Export UI
      </button>
    </div>
  </div>

  @if (bannerMessage(); as banner) {
    <div class="header-banner" [class.header-banner--success]="banner.type === 'success'" [class.header-banner--error]="banner.type === 'error'">
      <span>{{ banner.text }}</span>
      <button type="button" class="header-banner__close" (click)="dismissBannerMessage()">‚úñ</button>
    </div>
  }
</header>

@if (exportModalOpen()) {
  @if (exportArtifacts(); as artifacts) {
    <div class="export-modal-backdrop" (click)="closeExportModal()">
      <div class="export-modal" (click)="$event.stopPropagation()">
        <div class="export-modal__header">
          <h4>Export UI Artifacts</h4>
          <button type="button" class="export-modal__close" (click)="closeExportModal()">‚úñ</button>
        </div>
        <div class="export-modal__body">
          <section class="export-section">
            <div class="export-section__header export-section__header--toggle">
              <div class="export-section__heading">
                <h5>TypeScript Snippet</h5>
                <div class="export-mode-toggle">
                  <label class="export-mode-option">
                    <input
                      type="radio"
                      name="export-mode"
                      [checked]="exportMode() === 'combined'"
                      (change)="setExportMode('combined')"
                    />
                    <span>Single call</span>
                  </label>
                  <label class="export-mode-option">
                    <input
                      type="radio"
                      name="export-mode"
                      [checked]="exportMode() === 'split'"
                      (change)="setExportMode('split')"
                    />
                    <span>One call per root</span>
                  </label>
                </div>
              </div>

              @if (exportMode() === 'combined') {
                <div class="export-section__actions">
                  <button type="button" (click)="copyExportContent('typescript')">Copy</button>
                  <button type="button" (click)="downloadExportContent('typescript')">Download</button>
                </div>
              }
            </div>

            @if (exportMode() === 'combined') {
              <pre class="export-section__code">{{ artifacts.typescriptCode }}</pre>
            } @else {
              @if (artifacts.typescriptSnippets.length) {
                <div class="export-snippet-list">
                  @for (snippet of artifacts.typescriptSnippets; track snippet.elementId) {
                    <div class="export-snippet-card">
                      <div class="export-snippet-card__header">
                        <div class="export-snippet-card__title">
                          <span class="export-snippet-card__name">{{ snippet.name }}</span>
                          <span class="export-snippet-card__variable">{{ snippet.variableName }}</span>
                        </div>
                        <div class="export-snippet-card__actions">
                          <button type="button" (click)="copySnippet(snippet)">Copy</button>
                          <button type="button" (click)="downloadSnippet(snippet)">Download</button>
                        </div>
                      </div>
                      <pre class="export-snippet-card__code">{{ snippet.code }}</pre>
                    </div>
                  }
                </div>
              } @else {
                <div class="export-section__empty">
                  No root elements available for individual export.
                </div>
              }
            }
          </section>
          <section class="export-section">
            <div class="export-section__header">
              <h5>Strings JSON</h5>
              <div class="export-section__actions">
                <button type="button" (click)="copyExportContent('strings')">Copy</button>
                <button type="button" (click)="downloadExportContent('strings')">Download</button>
              </div>
            </div>
            <pre class="export-section__code">{{ artifacts.stringsJson }}</pre>
          </section>
        </div>
      </div>
    </div>
  }
}

@if (importModalOpen()) {
  <div class="export-modal-backdrop" (click)="closeImportModal()">
    <div class="export-modal import-modal" (click)="$event.stopPropagation()">
      <div class="export-modal__header">
        <h4>Import UI Code</h4>
        <button type="button" class="export-modal__close" (click)="closeImportModal()">‚úñ</button>
      </div>
      <div class="export-modal__body import-modal__body">
        <div class="import-form">
          <label for="import-source">Paste the TypeScript snippet generated by Export UI:</label>
          <textarea
            id="import-source"
            class="import-textarea"
            rows="14"
            [value]="importSource()"
            (input)="onImportSourceChange($event)"
            placeholder="const widget = modlib.ParseUI(...);"
          ></textarea>
          <p class="import-help">By default, existing elements are replaced. Enable append to keep the current layout. Your project is auto-saved before import.</p>
          <div class="import-mode-toggle">
            <label class="mode-switch">
              <input
                type="checkbox"
                [checked]="importMode() === 'append'"
                (change)="setImportMode($event)"
              />
              <span class="mode-switch__indicator"></span>
              <span class="mode-switch__label">Append to existing UI</span>
            </label>
            <p class="import-mode-toggle__hint">
              When enabled, imported root elements will be added without clearing the current layout.
            </p>
          </div>
          @if (importError(); as error) {
            <div class="import-feedback import-feedback--error">{{ error }}</div>
          }
        </div>
        <div class="import-actions">
          <button type="button" class="import-submit" (click)="submitImport()">Import</button>
          <button type="button" class="import-cancel" (click)="closeImportModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
}
